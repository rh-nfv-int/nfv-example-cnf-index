name: DCI

on:
  push:
    branches: ocp_412
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
      - "v[0-9]+.[0-9]+.[0-9]+-[0-9]+"
  workflow_dispatch:

env:
  REGISTRY: quay.io
  OCP_VERSIONS: "4.8,4.9"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Get repo name
        run: echo "::set-output name=name::${GITHUB_REPOSITORY/*\/}"
        id: repo

      - name: Create DCI components
        uses: tonyskapunk/dci-component@v0.2.0
        with:
          dciClientId: ${{ secrets.DCI_CLIENT_ID }}
          dciApiSecret: ${{ secrets.DCI_API_SECRET }}
          dciTopicVersion: ${{ env.OCP_VERSIONS }}
          componentName: ${{ github.ref_name }}-00
          componentCanonicalName: ${{ steps.repo.outputs.name }}:${{ github.ref_name }}
          componentType: nfv-example-cnf-index
          componentData: '{"url": "${{ env.REGISTRY }}/${{ github.repository_owner }}/nfv-example-cnf-catalog"}'
        id: dci

      - name: Results
        run: |
          echo "## DCI components" >> ${GITHUB_STEP_SUMMARY}
          echo "" >> ${GITHUB_STEP_SUMMARY}
          echo "\`\`\`JSON" >> ${GITHUB_STEP_SUMMARY}
          <<<'${{ steps.dci.outputs.components }}' jq . >> ${GITHUB_STEP_SUMMARY} 
          echo "\`\`\`" >> ${GITHUB_STEP_SUMMARY}
